<!DOCTYPE html>
<html>
<head>
	<title>Водомерка</title>
	<meta charset="utf-8">
	 <link rel="icon" href="path/to/oa.png" type="image/png">
</head>
<body>
	<script>
let geolocationAllowed = localStorage.getItem('geolocationAllowed');

if (geolocationAllowed === 'true') {
  // Доступ к местоположению разрешен, выполняем запрос
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(successFunction, errorFunction);
  } else {
    // Ваш браузер не поддерживает геолокацию
  }
} else {
  // Пользователь еще не принял решение о доступе к местоположению
  window.onload = function() {
    if (!navigator.geolocation) {
      // Ваш браузер не поддерживает геолокацию
      return;
    }
    navigator.permissions.query({name:'geolocation'}).then(function(permissionStatus) {
      if (permissionStatus.state === 'denied') {
        alert("Для синхронизации времени предоставьте доступ к определению местоположения.");
        localStorage.setItem('geolocationAllowed', 'false');
      } else {
        permissionStatus.onchange = function() {
          if (permissionStatus.state === 'granted') {
            localStorage.setItem('geolocationAllowed', 'true');
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(successFunction, errorFunction);
            } else {
              // Ваш браузер не поддерживает геолокацию
            }
          } else {
            localStorage.setItem('geolocationAllowed', 'false');
          }
        };
        if (permissionStatus.state === 'granted') {
          localStorage.setItem('geolocationAllowed', 'true');
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(successFunction, errorFunction);
          } else {
            // Ваш браузер не поддерживает геолокацию
          }
        } else if (permissionStatus.state === 'prompt') {
          // Предлагаем пользователю разрешить доступ к местоположению
          if (confirm("Разрешить сайту использовать ваше местоположение?")) {
            permissionStatus.request().then(function() {
              localStorage.setItem('geolocationAllowed', 'true');
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successFunction, errorFunction);
              } else {
                // Ваш браузер не поддерживает геолокацию
              }
            }).catch(function() {
              localStorage.setItem('geolocationAllowed', 'false');
            });
          } else {
            localStorage.setItem('geolocationAllowed', 'false');
          }
        } else {
          localStorage.setItem('geolocationAllowed', 'false');
        }
      }
    });
  };
}

	</script>
</body>
	
    <title>Водомерка</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        background-color: lightgray;
        text-align: center;
        font-size: 2em;
      }
      
      button {
        background-color: lightgreen;
        font-size: 1.5em;
        border-radius: 10px;
      }
      
      input[type="number"] {
        width: 4em;
        font-size: 2em;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh;">
	     <link rel="icon" href="path/to/aquarius.png" type="image/png">
      <label for="volume">Водомерка</label>
      <label for="volume">Объём</label>
      <input type="number" id="volume" name="volume" value="10" maxlength="2"><br><br>
      <button id="start" onclick="startStop()">Старт</button>
<label for="volume">----</label>
<button style="padding: 10px; font-size: 12px;" onclick="location.href='passport.html'">Паспорт скважины</button>

      <br><br>
      <div id="timer">00:00</div>
      <br>
      <div id="result"></div>
    </div>
    <script>
//evn: "API_GOOGLE_SHEETS"

      let startTime;
      let timerId;
      let userLocation;

      function checkLocalStorage() {
        const localStorageKey = "locationPermission";
        const result = document.getElementById("result");
        const button = document.getElementById("start");
	const api_key = process.env.API_GOOGLE_SHEETS;
	      
        navigator.permissions.query({ name: "geolocation" }).then((permissionStatus) => {
          if (permissionStatus.state === "granted") {
            const localStorageValue = localStorage.getItem(localStorageKey);
            if (localStorageValue) {
              getLocation();
            } else {
              localStorage.setItem(localStorageKey, "true");
              getLocation();
              result.textContent = "";
              button.disabled = false;
            }
          } else {
            result.textContent = "Для синхронизации времени предоставь доступ";
            button.disabled = true;
            permissionStatus.onchange = () => {
              if (permissionStatus.state === "granted") {
                localStorage.setItem(localStorageKey, "true");
              //  getLocation();
             //   result.textContent = "";
                button.disabled = false;
              }
            };
          }
        });
      }

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }

      function showPosition(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const result = document.getElementById("result");
       // result.textContent = `Ваше местоположение: ${latitude}, ${longitude}`;

        // Сохраняем координаты в переменных
        userLocation = {
          latitude,
          longitude
        };
      }

function calculateVolume() {
  const volume = document.getElementById("volume").value;
  const elapsedTime = Date.now() - startTime;
  let calculatedVolume = 0;

  if (elapsedTime !== 0) {
    calculatedVolume = volume * 60 / (elapsedTime / 60000);
  }

  return calculatedVolume.toFixed(2);
}

function sendData() {
  // Get latitude and longitude
  const latitude = userLocation.latitude;
  const longitude = userLocation.longitude;

  // Calculate volume
  const calculatedVolume = calculateVolume();

  // Only submit the data if the calculated volume is not 0.00
  if (calculatedVolume !== "0.00") {
    // Construct the URL to submit the data to the Google Form
    const url = `https://docs.google.com/forms/d/e/1FAIpQLSc3tyupksOD79esWtNwB6D-Xckkl8ieq-MaiaRyoP4Q8keAWA/formResponse?&submit=Submit&usp=pp_url&entry.1481308283=${calculatedVolume}л.ч&entry.1038701574=Буровой Дед&entry.1483754179=${latitude},${longitude}`;

    // Submit the data to the Google Form using fetch API
    fetch(url, {
      method: 'POST'
    });
  }
}
function startStop() {
  const button = document.getElementById("start");
  const timer = document.getElementById("timer");
  const result = document.getElementById("result");

  if (button.textContent === "Старт") {
    button.textContent = "Стоп";
    getLocation();
    startTime = Date.now();
    timerId = setInterval(() => {
      const elapsedTime = Date.now() - startTime;
      const minutes = Math.floor(elapsedTime / 60000);
      const seconds = Math.floor((elapsedTime % 60000) / 1000);
      const milliseconds = Math.floor(elapsedTime % 1000);
      timer.textContent = `${minutes < 10 ? "0" + minutes : minutes}:${seconds < 10 ? "0" + seconds : seconds}.${milliseconds < 100 ? "0" + milliseconds : milliseconds}`;

      result.textContent = `Дебит скважины: ${calculateVolume()} Лит/Час`;

    }, 10); // обновляем таймер каждые 10 миллисекунд
  } else {
    button.textContent = "Старт";
    clearInterval(timerId);
    sendData();
  }
}

    </script>

</body>

  </body>
</html>
